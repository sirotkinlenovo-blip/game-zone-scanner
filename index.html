<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAME ZONE - –°–∫–∞–Ω–µ—Ä –∏–≥—Ä</title>
    <meta name="theme-color" content="#0078D7">
    <meta name="description" content="–°–∫–∞–Ω–µ—Ä –∏–≥—Ä–æ–≤—ã—Ö –¥–∏—Å–∫–æ–≤ –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞ GAME ZONE">
    
    <!-- PWA –º–µ—Ç–∞-—Ç–µ–≥–∏ -->
    <link rel="manifest" href="manifest.json?v=2.9">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÆ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÆ</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GAME ZONE">
    
    <style>
        /* –¢–í–û–ô CSS –ö–û–î –û–°–¢–ê–ï–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            overscroll-behavior-y: none;
        }
        /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ ... */
    </style>
</head>
<body>
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–µ -->
    <div id="install-prompt" class="install-prompt">
        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ GAME ZONE –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞!
        <button id="install-btn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button id="dismiss-install" style="background: #6c757d;">–ü–æ–∑–∂–µ</button>
    </div>

    <div class="container">
        <!-- –¢–í–û–ô HTML –ö–û–î –û–°–¢–ê–ï–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô -->
        <div class="header">
            <div class="store-icon">GZ</div>
            <div>
                <h1>GAME ZONE</h1>
                <p>–°–∫–∞–Ω–µ—Ä –∏–≥—Ä–æ–≤—ã—Ö –¥–∏—Å–∫–æ–≤</p>
            </div>
        </div>

        <!-- –û—Å—Ç–∞–ª—å–Ω–æ–π HTML –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
        
        <div class="app-version">
            –í–µ—Ä—Å–∏—è 2.9 | GAME ZONE PWA | <span id="cache-status">üîÑ</span>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->

    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.1/dist/quagga.min.js"></script>
    
    <script>
        // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –û–ë–ù–û–í–õ–ï–ù–ò–ô
        const APP_VERSION = "2.9";
        const CACHE_VERSION = "v2.9";

        // PWA —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
        class PWAInstaller {
            constructor() {
                this.deferredPrompt = null;
                this.init();
            }

            init() {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showInstallPrompt();
                });

                window.addEventListener('appinstalled', () => {
                    console.log('PWA —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                    this.hideInstallPrompt();
                    this.deferredPrompt = null;
                });

                document.getElementById('install-btn').addEventListener('click', () => {
                    this.installApp();
                });

                document.getElementById('dismiss-install').addEventListener('click', () => {
                    this.hideInstallPrompt();
                });
            }

            showInstallPrompt() {
                setTimeout(() => {
                    const prompt = document.getElementById('install-prompt');
                    prompt.style.display = 'block';
                    
                    setTimeout(() => {
                        this.hideInstallPrompt();
                    }, 15000);
                }, 5000);
            }

            hideInstallPrompt() {
                const prompt = document.getElementById('install-prompt');
                prompt.style.display = 'none';
            }

            async installApp() {
                if (this.deferredPrompt) {
                    this.deferredPrompt.prompt();
                    const { outcome } = await this.deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω—è–ª —É—Å—Ç–∞–Ω–æ–≤–∫—É');
                    }
                    
                    this.deferredPrompt = null;
                    this.hideInstallPrompt();
                }
            }
        }

        // –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        class GameScannerApp {
            constructor() {
                this.sheetsUrl = 'https://docs.google.com/spreadsheets/d/1fMWJan1HP7tcKwa_hm86oCm0KPtC_zN50UhU72Q8xeA/export?format=csv&gid=1995791598';
                this.localStorageKey = 'gameZoneData';
                this.localDataKey = 'gameZoneGamesData';
                this.isScanning = false;
                this.gamesData = [];
                this.cameraStream = null;
                this.scanningTimeout = null;
                this.quaggaInitialized = false;
                this.lastScannedCode = null;
                this.scanCooldown = false;
                this.isDataLoaded = false;
                
                this.scannedGames = [];
                this.appVersion = APP_VERSION;
                
                this.init();
            }

            async init() {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ä—Å–∏—é
                this.showVersionInfo();
                
                this.setupEventListeners();
                this.loadFromLocalStorage();
                this.checkForUpdates();
                
                new PWAInstaller();
                this.registerServiceWorker();
                
                console.log(`GAME ZONE Scanner ${this.appVersion} - PWA –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ`);
            }

            showVersionInfo() {
                console.log(`üöÄ –ó–∞–ø—É—â–µ–Ω–∞ –≤–µ—Ä—Å–∏—è ${APP_VERSION}`);
                document.getElementById('cache-status').textContent = '‚úÖ ' + APP_VERSION;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –±–æ–ª–µ–µ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –≤ –∫—ç—à–µ
                this.checkForNewVersion();
            }

            async checkForNewVersion() {
                // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–µ–∂—É—é –≤–µ—Ä—Å–∏—é —Å–∫—Ä–∏–ø—Ç–∞
                try {
                    const response = await fetch(window.location.href + '?v=' + Date.now());
                    const text = await response.text();
                    
                    // –ò—â–µ–º –≤–µ—Ä—Å–∏—é –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º HTML
                    const versionMatch = text.match(/–í–µ—Ä—Å–∏—è\s+([\d.]+)/);
                    if (versionMatch && versionMatch[1] !== APP_VERSION) {
                        console.log(`üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: ${versionMatch[1]}`);
                        document.getElementById('cache-status').textContent = 'üîÑ –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è';
                        
                        // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ–±–Ω–æ–≤–∏—Ç—å
                        if (confirm(`–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è ${versionMatch[1]}! –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å?`)) {
                            this.forceUpdate();
                        }
                    }
                } catch (error) {
                    console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                }
            }

            forceUpdate() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistration().then(registration => {
                        if (registration) {
                            registration.update().then(() => {
                                console.log('Service Worker –æ–±–Ω–æ–≤–ª–µ–Ω');
                                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                                window.location.reload();
                            });
                        }
                    });
                } else {
                    window.location.reload();
                }
            }

            async registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫—ç—à–∏ –ø–µ—Ä–µ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π
                        await this.clearOldCaches();
                        
                        const registration = await navigator.serviceWorker.register('./sw.js?v=' + CACHE_VERSION);
                        console.log('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration);
                        
                        // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç Service Worker
                        navigator.serviceWorker.addEventListener('message', event => {
                            if (event.data && event.data.type === 'NEW_VERSION') {
                                console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è:', event.data.version);
                                this.showUpdateNotification();
                            }
                        });
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                        registration.addEventListener('updatefound', () => {
                            console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Service Worker');
                            const newWorker = registration.installing;
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    this.showUpdateNotification();
                                }
                            });
                        });
                        
                    } catch (error) {
                        console.log('Service Worker –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', error);
                    }
                }
            }

            async clearOldCaches() {
                if ('caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        const oldCaches = cacheNames.filter(name => name.startsWith('game-zone-') && name !== CACHE_VERSION);
                        
                        await Promise.all(
                            oldCaches.map(cacheName => {
                                console.log('–£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫—ç—à:', cacheName);
                                return caches.delete(cacheName);
                            })
                        );
                    } catch (error) {
                        console.log('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞:', error);
                    }
                }
            }

            showUpdateNotification() {
                const statusElement = document.getElementById('cache-status');
                statusElement.innerHTML = 'üîÑ –î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ! <button onclick="location.reload()">–û–±–Ω–æ–≤–∏—Ç—å</button>';
                statusElement.style.color = '#dc3545';
                statusElement.style.fontWeight = 'bold';
            }

            // –û–°–¢–ê–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
            setupEventListeners() {
                document.getElementById('scanner-container').addEventListener('click', () => this.startScanner());
                
                document.getElementById('search-btn').addEventListener('click', () => {
                    const barcode = document.getElementById('barcode-input').value.trim();
                    if (barcode) this.findGameByBarcode(barcode);
                });
                
                document.getElementById('barcode-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const barcode = e.target.value.trim();
                        if (barcode) this.findGameByBarcode(barcode);
                    }
                });
                
                document.getElementById('summary-btn').addEventListener('click', () => this.showSummary());
                document.getElementById('reset-scans-btn').addEventListener('click', () => this.resetScannedGames());
                document.getElementById('close-summary-btn').addEventListener('click', () => this.hideSummary());
                
                document.getElementById('close-camera').addEventListener('click', () => this.stopScanner());
                document.getElementById('restart-camera').addEventListener('click', () => this.restartCamera());
                document.getElementById('modal-overlay').addEventListener('click', () => this.stopScanner());
            }

            // –û–°–¢–ê–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ –ö–õ–ê–°–°–ê –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
            loadFromLocalStorage() {
                try {
                    const savedData = localStorage.getItem(this.localDataKey);
                    const savedScans = localStorage.getItem(this.localStorageKey);
                    
                    if (savedData) {
                        this.gamesData = JSON.parse(savedData);
                        this.isDataLoaded = true;
                        console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${this.gamesData.length} –∏–≥—Ä –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞`);
                        document.getElementById('status').textContent = `‚úÖ –ì–æ—Ç–æ–≤! ${this.gamesData.length} –∏–≥—Ä –≤ –±–∞–∑–µ`;
                    } else {
                        document.getElementById('status').textContent = '‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...';
                    }
                    
                    if (savedScans) {
                        this.scannedGames = JSON.parse(savedScans);
                        this.updateSummaryButton();
                    }
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
                    document.getElementById('status').textContent = '‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...';
                }
            }

            // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...

        }

        document.addEventListener('DOMContentLoaded', () => {
            new GameScannerApp();
        });

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        window.forceAppUpdate = function() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    if (registration) {
                        registration.unregister().then(() => {
                            caches.keys().then(cacheNames => {
                                cacheNames.forEach(cacheName => {
                                    caches.delete(cacheName);
                                });
                                window.location.reload();
                            });
                        });
                    }
                });
            } else {
                window.location.reload();
            }
        };
    </script>
</body>
</html>
